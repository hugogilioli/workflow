generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

enum Role {
  VIEWER
  OPERATOR
  ADMIN
}

enum ItemStatus {
  PENDING
  PICKED_UP
  COMPLETE
}

enum CalcBasis {
  FIBER_FT
  STRAND_FT
  TOTAL_FT
}

enum CalcRounding {
  CEIL
  ROUND
  FLOOR
  NONE
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(OPERATOR)
  createdAt    DateTime @default(now())

  // ✅ opposite relation exists in MaterialRequest.user
  requests MaterialRequest[]
}

model Team {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  requests MaterialRequest[]
}

model ProjectSite {
  id           String   @id @default(cuid())
  name         String   @unique
  lastFiberFt  Float?
  lastStrandFt Float?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  requests MaterialRequest[]
}

model Material {
  id          String   @id @default(cuid())
  sapPn       String   @unique
  name        String
  description String?
  unit        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // ✅ calc rule (optional)
  calcBasis    CalcBasis?
  calcFactor   Float?
  calcRounding CalcRounding @default(CEIL)

  requestItems MaterialRequestItem[]
}

model MaterialRequest {
  id          String   @id @default(cuid())
  requestCode String   @unique
  projectSite String
  requestedBy String
  date        DateTime
  createdAt   DateTime @default(now())

  // ✅ feet persisted
  fiberFt  Float?
  strandFt Float?

  // ✅ creator user (opposite of User.requests)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // ✅ optional normalized project site
  projectSiteRefId String?
  projectSiteRef   ProjectSite? @relation(fields: [projectSiteRefId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  items MaterialRequestItem[]
}

model MaterialRequestItem {
  id        String          @id @default(cuid())
  requestId String
  request   MaterialRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  materialId String
  material   Material @relation(fields: [materialId], references: [id])

  itemNumber Int
  quantity   Int
  notes      String?
  status     ItemStatus @default(PENDING)
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId     String?
  userEmail  String?
  action     String
  entityType String
  entityId   String?
  message    String
  metaJson   String?

  @@index([createdAt])
  @@index([action])
  @@index([entityType])
}
